<?xml version="1.0" encoding="UTF-8"?>
<dashboard version="2.0" theme="dark">
  <label>Nodeheim Network Analysis</label>
  <description>Network Discovery and Security Analysis Dashboard</description>

  <!-- Control Panel -->
  <row>
    <panel>
      <title>Network Scan Controls</title>
      <input type="dropdown" token="subnet">
        <label>Target Network</label>
        <choice value="192.168.1.0/24">192.168.1.0/24</choice>
        <choice value="10.0.0.0/24">10.0.0.0/24</choice>
        <choice value="172.16.0.0/24">172.16.0.0/24</choice>
        <default>192.168.1.0/24</default>
      </input>
      <input type="dropdown" token="scan_type">
        <label>Scan Type</label>
        <choice value="quick_scan">Quick Scan (Ping sweep)</choice>
        <choice value="basic_scan">Basic Scan (Service detection)</choice>
        <choice value="full_scan">Full Scan (Comprehensive)</choice>
        <default>basic_scan</default>
      </input>
      <html>
        <div style="padding: 10px;">
          <button id="start_scan" class="btn btn-primary">Start Scan</button>
          <span id="scan_status" style="margin-left: 10px;"></span>
        </div>
      </html>
    </panel>
  </row>

  <!-- Network Metrics -->
  <row>
    <panel>
      <title>Network Overview</title>
      <single>
        <title>Total Hosts</title>
        <search id="base_metrics">
          <query>| nodeheim_scan $subnet$ $scan_type$ | stats count as total_hosts</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <title>Active Services</title>
      <chart>
        <search base="base_metrics">
          <query>| stats count by services</query>
        </search>
        <option name="charting.chart">pie</option>
      </chart>
    </panel>
  </row>

  <!-- Host Details -->
  <row>
    <panel>
      <title>Host Details</title>
      <table>
        <search>
          <query>| nodeheim_scan $subnet$ $scan_type$ | table host hostname os ports services</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
  </row>

  <!-- Network Analysis -->
  <row>
    <panel>
      <title>Network Analysis</title>
      <table>
        <search>
          <query>| nodeheim_scan $subnet$ $scan_type$ | nodeheim_analyze | table metrics.*</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
  </row>

  <!-- Network Topology -->
  <row>
    <panel>
      <title>Network Topology</title>
      <html>
        <div id="topology_viz" style="height:400px;"></div>
      </html>
      <search id="topology_data">
        <query>| nodeheim_scan $subnet$ $scan_type$ | nodeheim_topology</query>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </search>
    </panel>
  </row>

  <!-- Add JavaScript -->
  <row>
    <panel depends="$never$">
      <html>
        <script src="${SPLUNKWEB_URL_PREFIX}/static/app/nodeheim-splunk/visualizations/vis-network.min.js"></script>
        <script>
          require([
              "splunkjs/mvc",
              "splunkjs/mvc/searchmanager",
              "splunkjs/mvc/utils",
              "jquery"
          ], function(mvc, SearchManager, utils, $) {
              
              // Handle scan button click
              $("#start_scan").on("click", function() {
                  $(this).prop("disabled", true);
                  $("#scan_status").text("Scanning...");
                  
                  // Trigger searches to refresh
                  mvc.Components.get("base_metrics").startSearch();
                  mvc.Components.get("topology_data").startSearch();
              });
              
              // Update status when searches complete
              mvc.Components.get("base_metrics").on("search:done", function() {
                  $("#start_scan").prop("disabled", false);
                  $("#scan_status").text("Scan complete");
              });
          });
        </script>
      </html>
    </panel>
  </row>

</dashboard>
